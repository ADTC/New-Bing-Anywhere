"use strict";(()=>{var i="https://www.bing.com/";var T="https://chat.aiplus.lol/login",L=["zh-CN","ru","ru-ru"],h="114",u="114.0.1823.82",l=["csp_report","font","image","main_frame","media","object","other","ping","script","stylesheet","sub_frame","webbundle","websocket","webtransport","xmlhttprequest"];var O="modifyHeaders",x="redirect",ne="append",w="set",_=[{action:{type:O,requestHeaders:[{operation:w,header:"sec-ch-ua",value:'"Not.A/Brand";v="8", "Chromium";v="114", "Microsoft Edge";v="114"'},{operation:w,header:"sec-ch-ua-full-version",value:`"${u}"`},{operation:w,header:"sec-ch-ua-full-version-list",value:'"Not.A/Brand";v="8.0.0.0", "Chromium";v="114.0.5735.201", "Microsoft Edge";v="114.0.1823.82"'},{operation:w,header:"sec-ms-gec-version",value:`1-${u}`},{operation:w,header:"User-Agent",value:`Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${h}.0.0.0 Safari/537.36 Edg/${u}`}]},condition:{requestDomains:["bing.com","www.bing.com","cn.bing.com"],resourceTypes:l}},{action:{type:x,redirect:{regexSubstitution:"\\1setlang=zh-Hans&mkt=zh-HK\\2"}},condition:{regexFilter:"(^https:\\/\\/www\\.bing\\.com\\/(?:search|\\?|account/action).*?)(?:mkt=zh-CN|cc=cn|cc=zh-cn|cc=zh)(.*)",isUrlFilterCaseSensitive:!1,requestDomains:["www.bing.com"],resourceTypes:l}},{action:{type:x,redirect:{regexSubstitution:"\\1setlang=ru&cc=clean&mkt=en-us\\2"}},condition:{regexFilter:"(^https:\\/\\/www\\.bing\\.com\\/(?:search|\\?|account/action).*?)(?:mkt=ru-ru|mkt=ru|cc=ru)(.*)",isUrlFilterCaseSensitive:!1,requestDomains:["www.bing.com"],resourceTypes:l}},{action:{type:x,redirect:{url:`${i}?setlang=zh-Hans&mkt=zh-HK`}},condition:{regexFilter:"\\/\\?(?:new-bing-anywhere|nba|run)",isUrlFilterCaseSensitive:!1,requestDomains:["www.bing.com"],resourceTypes:l}},{priority:99,action:{type:x,redirect:{regexSubstitution:`${i}\\1`}},condition:{requestDomains:["cn.bing.com","bing.com"],regexFilter:"^http(?:s)?:\\/\\/(?:cn\\.)?bing\\.com\\/(.*)",resourceTypes:l}},{action:{type:O,responseHeaders:[{header:"Set-Cookie",operation:ne,value:"SNRHOP=I=8; domain=.bing.com; path=/; secure; SameSite=None; HttpOnly;"}]},condition:{requestDomains:["bing.com","www.bing.com"]}}].map((e,o)=>({id:o+1,...e}));var N="2.3.0";var v={type:"git",url:"https://github.com/haozi/New-Bing-Anywhere"};var re=()=>{try{let e=chrome.i18n.getUILanguage().toLowerCase();return e==="zh-cn"||e==="zh-tw"||e==="zh-hk"||e==="zh"}catch{return!1}};var H="configV1",A=async()=>({showGoogleButtonOnBing:!0,showBingButtonOnGoogle:!0,showGuideToGithub:!0,showChat:!1,showRelease:!0,triggerMode:"Always",conversationStyle:"Balanced","X-Forwarded-For":void 0,...(await chrome.storage.sync.get(H))[H]});var $=e=>{chrome.runtime.onMessage.addListener((o,t,n)=>((async()=>{try{let{method:r,args:a}=o,c=await e[r](...a);n({code:200,msg:"ok",data:c})}catch(r){let a=r??{};n({code:500,msg:a.stack??a.message??r})}})(),!0))};var E=navigator.userAgent,ae=navigator.userAgentData,se=E.includes("Macintosh");var ie=E.includes("Edg/"),Ne=ae?.brands.findIndex(e=>e.brand==="Brave")>-1,U=re();var C=!!globalThis.__NBA_isCanary,y=C?`0.${N}`:N,z=()=>{let e=E;return ie||(se?e=`Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${h}.0.0.0 Safari/537.36 Edg/${u}`:e=`Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/${h}.0.0.0 Safari/537.36 Edg/${u}`),e},j=async e=>{let o=v.url;try{let t=await A(),r=`${o}/issues/new?title=&body=`,a="Please write your comment ABOVE this line, provide as much detailed information and screenshots as possible.Please confirm that you have read the #8 https://github.com/haozi/New-Bing-Anywhere/issues/8.The UA may not necessarily reflect your actual browser and platform, so please make sure to indicate them clearly.";U&&(a="\u8BF7\u5728\u6B64\u884C\u4E0A\u65B9\u53D1\u8868\u60A8\u7684\u8BA8\u8BBA\u3002\u8BF7\u786E\u8BA4\u5DF2\u7ECF\u9605\u8BFB\u4E86FAQ(https://github.com/haozi/New-Bing-Anywhere/issues/8)\uFF0C\u8BE6\u5C3D\u7684\u63CF\u8FF0\u548C\u622A\u56FE\u6709\u52A9\u4E8E\u6211\u4EEC\u5B9A\u4F4D\u95EE\u9898\uFF0C\u63CF\u8FF0\u4E0D\u6E05\u7684\u95EE\u9898\u4F1A\u88AB\u5173\u95ED\uFF0CUA \u4E0D\u4E00\u5B9A\u771F\u5B9E\u53CD\u6620\u60A8\u7684\u6D4F\u89C8\u5668\u548C\u5E73\u53F0\uFF0C\u8BF7\u5907\u6CE8\u6E05\u695A");let c=` 



<!--  ${a} -->
<pre>
`+Object.entries({Version:`${y}${C?" (Canary)":""} `,UA:navigator.userAgent,Lang:chrome.i18n.getUILanguage(),AcceptLangs:(await chrome.i18n.getAcceptLanguages()).join(", "),config:JSON.stringify(t),...e}).map(([b,p])=>p?`${b}: ${p}`:"").join(`
`)+"</pre>";return r+=encodeURIComponent(c.slice(0,2e3)),r}catch{return o}},m=(e="",o)=>{try{return new URL(e,o)}catch{return{searchParams:{get:()=>null}}}},R=e=>{try{return new URLSearchParams(e)}catch{return{get:()=>null}}},g=async e=>{let o=await chrome.tabs.query({currentWindow:!0}),t=m(e),n=o.find(r=>r.url?.startsWith(t.origin));return n==null?n=await chrome.tabs.create({url:e}):await Promise.all([chrome.tabs.move(n.id,{index:o.length-1}),n.url!==e&&chrome.tabs.update(n.id,{url:e}),chrome.tabs.update(n.id,{active:!0,url:n.url!==e?e:void 0})].filter(Boolean)),n};var I={openChat:{title:"\u{1F4AC} New Bing",contexts:["action"],onclick:e=>{g("https://www.bing.com/search?q=Bing+AI&showconv=1")}},openImageCreate:{title:"\u{1F5BC}\uFE0F New Bing Image Creator",contexts:["action"],onclick:e=>{g("https://www.bing.com/create")}},likeIt:{title:"\u2764\uFE0F Like it",contexts:["action"],onclick:()=>{g("https://chrome.google.com/webstore/detail/new-bing-anywhere-bing-ch/hceobhjokpdbogjkplmfjeomkeckkngi/reviews?hl=en")}},reportIssues:{title:"\u{1F41B} Report issues",contexts:["action"],onclick:async e=>{let o=await j();g(o)}}};var F=()=>{chrome.contextMenus.removeAll(()=>{for(let[e,o]of Object.entries(I))chrome.contextMenus.create({id:e,title:o.title,contexts:o.contexts})}),chrome.contextMenus.onClicked.addListener((e,o)=>{let{menuItemId:t}=e,n=I[t];n?.onclick&&n.onclick(e,o)})};var S,ce=new Uint8Array(16);function P(){if(!S&&(S=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!S))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return S(ce)}var s=[];for(let e=0;e<256;++e)s.push((e+256).toString(16).slice(1));function G(e,o=0){return(s[e[o+0]]+s[e[o+1]]+s[e[o+2]]+s[e[o+3]]+"-"+s[e[o+4]]+s[e[o+5]]+"-"+s[e[o+6]]+s[e[o+7]]+"-"+s[e[o+8]]+s[e[o+9]]+"-"+s[e[o+10]]+s[e[o+11]]+s[e[o+12]]+s[e[o+13]]+s[e[o+14]]+s[e[o+15]]).toLowerCase()}var le=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),D={randomUUID:le};function ge(e,o,t){if(D.randomUUID&&!o&&!e)return D.randomUUID();e=e||{};let n=e.random||(e.rng||P)();if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,o){t=t||0;for(let r=0;r<16;++r)o[t+r]=n[r];return o}return G(n)}var B=ge;var W=async e=>{let o=`https://sydney.bing.com/sydney/GetConversation?conversationId=${encodeURIComponent(e.session.conversationId)}&source=${encodeURIComponent(e.source)}&participantId=${encodeURIComponent(e.participantId)}&conversationSignature=${encodeURIComponent(e.session.conversationSignature)}&traceId=${B()}`;try{return await fetch(o).then(n=>n.json())}catch{return null}},q={};var Y=async e=>await new Promise((o,t)=>{let n=q[e];if(n==null)throw new Error(`WebSocket ${e} not found`);n.send(JSON.stringify({type:6})+""),o(null)});var K=async e=>{q[e]?.close(),q[e]=null};var d="notification",k="notification:hide",ue=async()=>{let e;try{e=await fetch("https://api.github.com/repos/haozi/New-Bing-Anywhere/issues/24").then(async o=>await o.json())}catch{}return e},V=async()=>{let{[d]:e}=await chrome.storage.local.get(d);if(!e||e.lastModify&&Date.now()-e.lastModify>36e5){await chrome.storage.local.remove(d);let n=await ue();n&&await chrome.storage.local.set({[d]:{data:n,lastModify:Date.now()}})}let{[k]:o,[d]:t}=await chrome.storage.local.get([k,d]);return!t?.data||!(t.data.title&&t.data.state==="open")||o===1&&t.data.title===e.data?.title?null:(await chrome.storage.local.remove(k),t.data)},X=async()=>{chrome.storage.local.set({[k]:1})};var me=async()=>({version:y}),de=async({url:e}={})=>{let o=await chrome.tabs.query({currentWindow:!0}),t=m(e),n=o.find(te=>te.url?.startsWith(t.origin));n==null?n=await chrome.tabs.create({url:e}):n.id!=null&&await Promise.all([chrome.tabs.move(n.id,{index:o.length-1}),chrome.tabs.update(n.id,{active:!0})]);let r=e,a="",c="",b=t.hostname==="www.google.com",p=t.hostname==="www.bing.com";b?(a=t.searchParams.get("q")??"",c=m(n.url).searchParams.get("q")??"",m(n.url).searchParams.get("q")):p&&(a=t.searchParams.get("q")??"",c=m(n.url).searchParams.get("q")??""),a=a.trim(),c=c.trim(),!(a&&a===c)&&(b?r=`${t.origin}${t.pathname}?q=${encodeURIComponent(a)}`:p&&(r=`${t.origin}${t.pathname}?q=${encodeURIComponent(a)}`),await chrome.tabs.update(n.id,{url:r}))},J={getEnv:me,openUrlInSameTab:de,getNotification:V,hideNotification:X,"bing.getFromConversation":W,"bing.bingChatPing":Y,"bing.bingChatCloseWebSocket":K};var f=async(e,o={})=>await chrome.cookies.set({domain:o.domain,storeId:o.storeId,path:o.path,httpOnly:o.httpOnly,secure:o.secure,sameSite:o.sameSite,expirationDate:o.expirationDate,...e});var Q=()=>{F(),$(J),chrome.runtime.onInstalled.addListener(async e=>{let o=await A(),t=v.url;if(C){g(`${t}/tree/canary`);return}e.reason==="install"?g(t):e.reason==="update"&&o.showRelease&&g(`${t}/releases/tag/v${y}`)}),chrome.webRequest.onBeforeRequest.addListener(()=>{chrome.cookies.get({name:"_EDGE_S",url:i},e=>{let o=e?.value;if(!o)return;let t=R(o),n=t.get("mkt")?.toLowerCase()??"";L.map(r=>r.toLowerCase()).includes(n)&&(n==="zh-cn"?(t.set("mkt","zh-HK"),t.set("ui","zh-hans")):t.delete("mkt"),f({url:i,name:e.name,value:t.toString()},e))}),chrome.cookies.get({name:"_RwBf",url:i},e=>{let o=e?.value;if(!o){f({url:i,name:"_RwBf",value:"wls=2",domain:".bing.com",httpOnly:!0});return}let t=R(o),n=t.get("wls");n!=="2"&&n!==""&&t.set("wls","2"),f({url:i,name:"_RwBf",domain:".bing.com",httpOnly:!0,value:t.toString()},e)}),chrome.cookies.get({name:"ANON",url:i},e=>{let o=e?.value;if(!o)return;let t=R(o);t.delete("A"),f({url:i,name:"ANON",domain:".bing.com",httpOnly:!0,value:t.toString()},e)})},{urls:[i+"*"],types:["main_frame"]})};var pe={"User-Agent":z()},he="modifyHeaders",we="redirect",ye="set",Z=[{priority:2001,action:{type:he,requestHeaders:Object.entries(pe).map(([e,o])=>({operation:ye,header:e,value:o}))},condition:{requestDomains:["bing.com","www.bing.com","cn.bing.com"],resourceTypes:l}},U&&{action:{type:we,redirect:{url:`${T}?invite_code=b90e84b5`}},condition:{requestDomains:["chat.aiplus.lol"],urlFilter:T,isUrlFilterCaseSensitive:!1,resourceTypes:l}}].filter(Boolean).map((e,o)=>({id:o+1+2e3,...e}));var ee=chrome,oe=[..._,...Z],fe=oe.filter(e=>e.action?.type==="modifyHeaders"&&e.action?.requestHeaders?.length),be=oe.filter(e=>e.action?.type==="modifyHeaders"&&e.action?.responseHeaders?.length);Q();ee.webRequest.onBeforeSendHeaders.addListener(e=>{if(!e.requestHeaders)return;let o=e.requestHeaders;for(let t of fe){let n=new URL(e.url);if(!t.condition||(t.condition?.requestDomains??[]).includes(n.hostname)||new RegExp(t.condition?.regexFilter??"",t.condition?.isUrlFilterCaseSensitive?"i":void 0).test(n.href)||n.href.includes(t.condition?.urlFilter??""))for(let r of t.action.requestHeaders??[])switch(r.operation){case"set":if(!e.requestHeaders.find(a=>a.name===r.header))o.push({name:r.header,value:r.value});else for(let a of e.requestHeaders)a.name.toLowerCase()===r.header.toLowerCase()&&(a.value=r.value);break;case"append":o.push({name:r.header,value:r.value});break;case"remove":{let a=o.findIndex(c=>c.name.toLowerCase()===r.header.toLowerCase());a>-1&&o.splice(a,1)}break;default:}}return{requestHeaders:o}},{urls:["<all_urls>"]},["blocking","requestHeaders"]);ee.webRequest.onHeadersReceived.addListener(e=>{if(!e.responseHeaders)return;let o=e.responseHeaders;for(let t of be)if(new RegExp(t.condition?.regexFilter??"",t.condition?.isUrlFilterCaseSensitive?"i":void 0).test(e.url))for(let n of t.action.responseHeaders??[])switch(n.operation){case"set":for(let r of e.responseHeaders)r.name.toLowerCase()===n.header.toLowerCase()?r.value=n.value:o.push({name:n.header,value:n.value});break;case"append":o.push({name:n.header,value:n.value});break;default:}return{responseHeaders:o}},{urls:["<all_urls>"]},["blocking","responseHeaders"]);})();
